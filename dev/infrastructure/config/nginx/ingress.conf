worker_processes auto;
error_log /dev/stderr warn;
pid /tmp/nginx.pid;

events {
  worker_connections 1024;
}

http {
  client_body_temp_path /tmp/client_temp;
  proxy_temp_path       /tmp/proxy_temp_path;
  fastcgi_temp_path     /tmp/fastcgi_temp;
  uwsgi_temp_path       /tmp/uwsgi_temp;
  scgi_temp_path        /tmp/scgi_temp;

  access_log /dev/stdout;

  # Docker registry requires large uploads
  client_max_body_size 0;
  chunked_transfer_encoding on;

  # Timeouts for large image pushes
  proxy_connect_timeout 900;
  proxy_send_timeout 900;
  proxy_read_timeout 900;
  send_timeout 900;

  # Proxy settings
  proxy_http_version 1.1;
  proxy_buffering off;
  proxy_set_header Host $http_host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # Upstream definitions
  upstream registry {
    server registry:5000;
  }

  upstream registry-ui {
    server registry-ui:80;
  }

  upstream powerdns-api {
    server powerdns:8081;
  }

  upstream powerdns-admin {
    server powerdns-admin:80;
  }

  upstream prometheus {
    server prometheus:9090;
  }

  upstream grafana {
    server grafana:3000;
  }

  upstream loki {
    server loki:3100;
  }

  upstream tempo {
    server tempo:3200;
  }

  upstream portal {
    server portal:80;
  }

  upstream excalidraw {
    server excalidraw:80;
  }

  upstream minio-api {
    server minio:9000;
  }

  upstream minio-console {
    server minio:9001;
  }

  upstream kind-ingress {
    server 172.20.0.2:32290;
  }

  # ==========================================================================
  # Registry UI and API - registry.macula.local
  # ==========================================================================
  server {
    listen 80;
    server_name registry.macula.local;

    # Add Docker-specific headers
    add_header 'Docker-Distribution-Api-Version' 'registry/2.0' always;

    # Web UI (default)
    location / {
      proxy_pass http://registry-ui/;
    }

    # Docker Registry API with CORS headers
    location /v2/ {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, HEAD" always;
      add_header Access-Control-Allow-Headers "Authorization, Accept, Content-Type, Cache-Control" always;
      add_header Access-Control-Expose-Headers "Docker-Content-Digest, Docker-Distribution-Api-Version" always;

      proxy_pass http://registry/v2/;
    }

    # Health check
    location /health {
      return 200 "OK - Registry\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # PowerDNS API - dns.macula.local
  # ==========================================================================
  server {
    listen 80;
    server_name dns.macula.local;

    location / {
      proxy_pass http://powerdns-api/;
    }

    # Health check
    location /health {
      return 200 "OK - PowerDNS API\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # PowerDNS Admin UI - dns-admin.macula.local
  # ==========================================================================
  server {
    listen 80;
    server_name dns-admin.macula.local;

    location / {
      proxy_pass http://powerdns-admin/;
      # PowerDNS Admin needs these headers
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
    }

    # Health check
    location /health {
      return 200 "OK - PowerDNS Admin\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # Portal - home.macula.local
  # ==========================================================================
  server {
    listen 80;
    server_name home.macula.local;

    location / {
      proxy_pass http://portal/;
    }

    # Health check
    location /health {
      return 200 "OK - Portal\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # Prometheus - prometheus.macula.local
  # ==========================================================================
  server {
    listen 80;
    server_name prometheus.macula.local;

    location / {
      proxy_pass http://prometheus/;
    }

    # Health check
    location /health {
      return 200 "OK - Prometheus\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # Grafana - grafana.macula.local
  # ==========================================================================
  server {
    listen 80;
    server_name grafana.macula.local;

    location / {
      proxy_pass http://grafana/;
      # Grafana needs these headers for proper operation
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
    }

    # Health check
    location /health {
      return 200 "OK - Grafana\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # Loki - loki.macula.local
  # ==========================================================================
  server {
    listen 80;
    server_name loki.macula.local;

    location / {
      proxy_pass http://loki/;
    }

    # Health check
    location /health {
      return 200 "OK - Loki\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # Tempo - tempo.macula.local
  # ==========================================================================
  server {
    listen 80;
    server_name tempo.macula.local;

    location / {
      proxy_pass http://tempo/;
    }

    # Health check
    location /health {
      return 200 "OK - Tempo\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # Excalidraw - draw.macula.local
  # ==========================================================================
  server {
    listen 80;
    server_name draw.macula.local;

    location / {
      proxy_pass http://excalidraw/;
      # WebSocket support for collaboration (if enabled in future)
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }

    # Health check
    location /health {
      return 200 "OK - Excalidraw\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # MinIO S3 API - s3.macula.local
  # ==========================================================================
  server {
    listen 80;
    server_name s3.macula.local;

    # Allow large uploads for S3
    client_max_body_size 0;

    location / {
      proxy_pass http://minio-api/;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Host $http_host;

      # S3 specific headers
      proxy_connect_timeout 300;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      chunked_transfer_encoding off;
    }

    # Health check
    location /health {
      return 200 "OK - MinIO S3 API\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # MinIO Console - s3-console.macula.local
  # ==========================================================================
  server {
    listen 80;
    server_name s3-console.macula.local;

    location / {
      proxy_pass http://minio-console/;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Host $http_host;

      # WebSocket support for MinIO Console
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }

    # Health check
    location /health {
      return 200 "OK - MinIO Console\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # Macula Console - console.macula.local (KinD cluster)
  # ==========================================================================
  server {
    listen 80;
    server_name console.macula.local;

    location / {
      proxy_pass http://kind-ingress/;
      proxy_set_header Host console.macula.local;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # WebSocket support for Phoenix LiveView
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }

    # Health check
    location /health {
      return 200 "OK - Macula Console\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # Backward compatibility - Direct registry access on port 5001
  # ==========================================================================
  server {
    listen 5001;
    server_name localhost;

    # Add Docker-specific headers
    add_header 'Docker-Distribution-Api-Version' 'registry/2.0' always;

    # Web UI (default)
    location / {
      proxy_pass http://registry-ui/;
    }

    # Docker Registry API
    location /v2/ {
      proxy_pass http://registry/v2/;
    }

    # Health check
    location /health {
      return 200 "OK - Registry (legacy port)\n";
      add_header Content-Type text/plain;
    }
  }

  # ==========================================================================
  # Default server - catch-all for undefined hosts
  # ==========================================================================
  server {
    listen 80 default_server;
    server_name _;

    location / {
      return 404 "Not Found\n\nAvailable services:\n\nInfrastructure:\n- http://registry.macula.local\n- http://dns.macula.local\n- http://dns-admin.macula.local\n\nObservability:\n- http://prometheus.macula.local\n- http://grafana.macula.local\n- http://loki.macula.local\n- http://tempo.macula.local\n\nApplications:\n- http://console.macula.local\n\nTools:\n- http://draw.macula.local\n\nData Services:\n- http://s3.macula.local\n- http://s3-console.macula.local\n- postgres://postgres.macula.local:5432\n";
      add_header Content-Type text/plain;
    }

    location /health {
      return 200 "OK - Macula Infrastructure Ingress\n";
      add_header Content-Type text/plain;
    }
  }
}
